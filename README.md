# é›¨äº‘è‡ªåŠ¨ç­¾åˆ° (Docker ç‰ˆ) v2.7

é›¨äº‘æ¯æ—¥è‡ªåŠ¨ç­¾åˆ°å·¥å…·ï¼Œæ”¯æŒ ARM / AMD64 å¹³å°ï¼ŒDocker ä¸€é”®éƒ¨ç½²ã€‚

## åŠŸèƒ½ç‰¹æ€§

- âœ… æ¯æ—¥è‡ªåŠ¨ç­¾åˆ°ï¼ˆéªŒè¯ç è¯†åˆ«ï¼‰
- âœ… æœåŠ¡å™¨åˆ°æœŸæ£€æŸ¥
- âœ… ç§¯åˆ†è‡ªåŠ¨ç»­è´¹ï¼ˆåˆ°æœŸå‰ 7 å¤©è‡ªåŠ¨ç»­è´¹ï¼‰
- âœ… Serveré…± / Bark ç­‰å¤šæ¸ é“é€šçŸ¥
- âœ… Docker å®¹å™¨åŒ–éƒ¨ç½²

## å¿«é€Ÿå¼€å§‹

```bash
# 1. ç¼–è¾‘ .env æ–‡ä»¶
cp .env.example .env
# å¡«å…¥ RAINYUN_USER å’Œ RAINYUN_PWD

# 2. æ„å»ºå¹¶è¿è¡Œ
docker-compose up --build
```

## å…¥å£ä¸ç»“æ„

- ç»Ÿä¸€å…¥å£ä¸º `python -m rainyun`ï¼ˆDocker/æœ¬åœ°ä¸€è‡´ï¼‰ã€‚  
- æ ¸å¿ƒä»£ç ä½äº `rainyun/` åŒ…å†…ï¼Œæ ¹ç›®å½•æ—§å…¥å£ä¸å…¼å®¹ shim å·²ç§»é™¤ã€‚

## ç¯å¢ƒå˜é‡

### åŸºç¡€é…ç½®ï¼ˆå¿…å¡«ï¼‰

| å˜é‡å | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| RAINYUN_USER | âœ… | - | é›¨äº‘ç”¨æˆ·å |
| RAINYUN_PWD | âœ… | - | é›¨äº‘å¯†ç  |
| TIMEOUT | âŒ | 15 | é¡µé¢åŠ è½½è¶…æ—¶(ç§’) |
| MAX_DELAY | âŒ | 90 | éšæœºå»¶æ—¶ä¸Šé™(åˆ†é’Ÿ) |
| DEBUG | âŒ | false | è°ƒè¯•æ¨¡å¼ï¼ˆè·³è¿‡å»¶æ—¶ï¼‰ |
| CHROME_LOW_MEMORY | âŒ | false | Chrome ä½å†…å­˜æ¨¡å¼ï¼ˆé€‚ç”¨äºä½é…ç½®æœåŠ¡å™¨ï¼‰ |

### æ¨é€æœåŠ¡ï¼ˆå¯é€‰ï¼‰

| å˜é‡å | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| PUSH_KEY | âŒ | - | Serveré…±æ¨é€å¯†é’¥ |
| BARK_PUSH | âŒ | - | Bark æ¨é€åœ°å€/è®¾å¤‡ç  |
| TG_BOT_TOKEN | âŒ | - | Telegram æœºå™¨äºº token |
| TG_USER_ID | âŒ | - | Telegram ç”¨æˆ· ID |

> â„¹ï¸ åªè¦é…ç½®äº†å¯¹åº” key/å¿…è¦å­—æ®µå³ä¼šå¯ç”¨ï¼Œå¯åŒæ—¶é…ç½®å¤šä¸ªï¼›å®Œæ•´åˆ—è¡¨è§ `.env.example` çš„ã€Œæ¨é€æœåŠ¡ã€åˆ†ç»„ã€‚
> åªéœ€åœ¨ `.env` ä¸­å¡«å†™å³å¯ï¼Œ`docker-compose.yml` å·²é€šè¿‡ `env_file` è‡ªåŠ¨åŠ è½½ï¼Œæ— éœ€é€æ¡å†™åˆ° `environment`ã€‚

### è‡ªåŠ¨ç»­è´¹ï¼ˆå¯é€‰ï¼‰

| å˜é‡å | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| RAINYUN_API_KEY | âŒ | - | é›¨äº‘ API å¯†é’¥ |
| AUTO_RENEW | âŒ | true | è‡ªåŠ¨ç»­è´¹å¼€å…³ |
| RENEW_THRESHOLD_DAYS | âŒ | 7 | ç»­è´¹è§¦å‘é˜ˆå€¼(å¤©) |
| RENEW_PRODUCT_IDS | âŒ | - | ç»­è´¹ç™½åå•(é€—å·åˆ†éš”äº§å“ID) |

> ğŸ’¡ **è·å– API å¯†é’¥**ï¼šé›¨äº‘åå° â†’ ç”¨æˆ·ä¸­å¿ƒ â†’ API å¯†é’¥
>
> ğŸ’° **ç»­è´¹æˆæœ¬**ï¼š7å¤© = 2258 ç§¯åˆ†ï¼Œç­¾åˆ°æ¯å¤© 500 ç§¯åˆ†
>
> ğŸ¯ **ç™½åå•æ¨¡å¼**ï¼šè®¾ç½® `RENEW_PRODUCT_IDS` ååªç»­è´¹æŒ‡å®šäº§å“ï¼Œç•™ç©ºåˆ™ç»­è´¹æ‰€æœ‰

### é«˜çº§é…ç½®ï¼ˆå¯é€‰ï¼‰

| å˜é‡å | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| APP_VERSION | âŒ | 2.7 | æ—¥å¿—æ˜¾ç¤ºçš„ç‰ˆæœ¬å· |
| APP_BASE_URL | âŒ | https://app.rainyun.com | é›¨äº‘ç«™ç‚¹åœ°å€ |
| API_BASE_URL | âŒ | https://api.v2.rainyun.com | API åŸºç¡€åœ°å€ |
| COOKIE_FILE | âŒ | cookies.json | ç™»å½• Cookie å­˜å‚¨æ–‡ä»¶ |
| POINTS_TO_CNY_RATE | âŒ | 2000 | ç§¯åˆ†å…‘æ¢æ¯”ä¾‹ |
| CAPTCHA_RETRY_LIMIT | âŒ | 5 | éªŒè¯ç æœ€å¤§é‡è¯•æ¬¡æ•° |
| CAPTCHA_RETRY_UNLIMITED | âŒ | false | éªŒè¯ç æ— é™é‡è¯•ï¼ˆç›´åˆ°æˆåŠŸï¼‰ |
| DOWNLOAD_TIMEOUT | âŒ | 10 | å›¾ç‰‡ä¸‹è½½è¶…æ—¶(ç§’) |
| DOWNLOAD_MAX_RETRIES | âŒ | 3 | å›¾ç‰‡ä¸‹è½½æœ€å¤§é‡è¯•æ¬¡æ•° |
| DOWNLOAD_RETRY_DELAY | âŒ | 2 | å›¾ç‰‡ä¸‹è½½é‡è¯•é—´éš”(ç§’) |
| REQUEST_TIMEOUT | âŒ | 15 | API è¯·æ±‚è¶…æ—¶(ç§’) |
| MAX_RETRIES | âŒ | 3 | API è¯·æ±‚æœ€å¤§é‡è¯•æ¬¡æ•° |
| RETRY_DELAY | âŒ | 2 | API è¯·æ±‚é‡è¯•é—´éš”(ç§’) |
| DEFAULT_RENEW_COST_7_DAYS | âŒ | 2258 | ç»­è´¹ä»·æ ¼å…œåº•å€¼ |

## å®šæ—¶ä»»åŠ¡

### æ–¹å¼ä¸€ï¼šå®¿ä¸»æœº crontabï¼ˆæ¨èï¼‰

```bash
# æ¯å¤©æ—©ä¸Š 8 ç‚¹æ‰§è¡Œ
0 8 * * * docker compose -f /path/to/docker-compose.yml up
```

### æ–¹å¼äºŒï¼šå®¹å™¨å†…å®šæ—¶æ¨¡å¼

ä½¿ç”¨ [supercronic](https://github.com/aptible/supercronic) å®ç°å®¹å™¨å†…å®šæ—¶è°ƒåº¦ï¼Œæ— éœ€é…ç½®å®¿ä¸»æœº crontabã€‚

```bash
# å¯åŠ¨å®šæ—¶æ¨¡å¼ï¼ˆå®¹å™¨æŒç»­è¿è¡Œï¼ŒæŒ‰è®¡åˆ’è‡ªåŠ¨æ‰§è¡Œï¼‰
docker compose -f docker-compose.yml -f docker-compose.cron.yml up -d --build

# æŸ¥çœ‹æ—¥å¿—
docker compose logs -f

# åœæ­¢
docker compose down
```

**å®šæ—¶æ¨¡å¼ç¯å¢ƒå˜é‡ï¼š**

| å˜é‡å | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| CRON_MODE | false | å®šæ—¶æ¨¡å¼å¼€å…³ï¼ˆä½¿ç”¨ override æ–‡ä»¶æ—¶è‡ªåŠ¨å¯ç”¨ï¼‰ |
| CRON_SCHEDULE | "0 8 * * *" | æ‰§è¡Œè®¡åˆ’ï¼ˆcron è¡¨è¾¾å¼ï¼‰ |

**cron è¡¨è¾¾å¼ç¤ºä¾‹ï¼š**

| è¡¨è¾¾å¼ | è¯´æ˜ |
|--------|------|
| `0 8 * * *` | æ¯å¤© 8:00 |
| `0 8,20 * * *` | æ¯å¤© 8:00 å’Œ 20:00 |
| `0 */6 * * *` | æ¯ 6 å°æ—¶ |
| `30 7 * * *` | æ¯å¤© 7:30 |

### ä»æ—§ç‰ˆæœ¬å‡çº§

å¦‚æœä½ ä¹‹å‰ä½¿ç”¨å®¿ä¸»æœº crontab å®šæ—¶æ‰§è¡Œï¼Œæƒ³åˆ‡æ¢åˆ°å®¹å™¨å†…å®šæ—¶æ¨¡å¼ï¼š

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
git pull

# 2. åœ¨ .env ä¸­è®¾ç½®å®šæ—¶è®¡åˆ’ï¼ˆå¯é€‰ï¼Œé»˜è®¤æ¯å¤© 8:00ï¼‰
# æ³¨æ„ï¼šCRON_MODE ä¸éœ€è¦æ‰‹åŠ¨è®¾ç½®ï¼Œoverride æ–‡ä»¶ä¼šè‡ªåŠ¨å¯ç”¨
CRON_SCHEDULE="0 8 * * *"

# 3. é‡æ–°æ„å»ºå¹¶å¯åŠ¨å®šæ—¶æ¨¡å¼
docker compose -f docker-compose.yml -f docker-compose.cron.yml up -d --build

# 4. åˆ é™¤å®¿ä¸»æœº crontab ä¸­çš„ç›¸å…³æ¡ç›®ï¼ˆå¯é€‰ï¼‰
crontab -l | grep -v "rainyun" | crontab -
# æˆ–æ‰‹åŠ¨ç¼–è¾‘: crontab -eï¼Œæ‰¾åˆ°å¹¶åˆ é™¤ rainyun ç›¸å…³è¡Œ
```

å¦‚æœä½ ä¹‹å‰é€šè¿‡ `python rainyun.py` å¯åŠ¨æˆ–è„šæœ¬ä¸­ä»å¯¼å…¥æ—§æ¨¡å—ï¼Œè¯·æ›´æ–°ä¸ºï¼š

- å¯åŠ¨å…¥å£ï¼š`python -m rainyun`
- å¯¼å…¥è·¯å¾„ï¼š`rainyun.api.client` / `rainyun.server.manager` / `rainyun.notify` / `rainyun.config`
- å¦‚æœ‰è‡ªå®šä¹‰ docker-compose volumeï¼Œè¯·ç§»é™¤ `./rainyun.py:/app/rainyun.py`

> âš ï¸ æ–°ç‰ˆæœ¬æ–°å¢äº† `entrypoint.sh` å’Œ `docker-compose.cron.yml` æ–‡ä»¶ï¼Œå‡çº§åéœ€è¦é‡æ–°æ„å»ºé•œåƒã€‚

## è‡´è°¢

æœ¬é¡¹ç›®åŸºäºä»¥ä¸‹ä»“åº“äºŒæ¬¡å¼€å‘ï¼š

| ç‰ˆæœ¬ | ä½œè€… | ä»“åº“ | è¯´æ˜ |
|------|------|------|------|
| åŸç‰ˆ | SerendipityR | [Rainyun-Qiandao](https://github.com/SerendipityR-2022/Rainyun-Qiandao) | åˆå§‹ Python ç‰ˆæœ¬ |
| äºŒæ”¹ | fatekey | [Rainyun-Qiandao](https://github.com/fatekey/Rainyun-Qiandao) | Docker åŒ–æ”¹é€  |
| ä¸‰æ”¹ | Jielumoon | æœ¬ä»“åº“ | ç¨³å®šæ€§ä¼˜åŒ– + è‡ªåŠ¨ç»­è´¹ |

## License

MIT
